/**
 * easy-sketch.js
 *
 * @link https://github.com/brian978/easy-sketch.js
 * @copyright Copyright (c) 2015
 * @license https://github.com/brian978/easy-sketch.js/blob/master/LICENSE New BSD License
 */

define("EasySketch/EasySketch",[],function(){function t(){}return t}),define("EasySketch/Event",["./EasySketch"],function(t){return t.Event=function(t,e,n){this.name=t,this.target=e,this.params=n,this._propagationStopped=!1},t.Event.prototype={getName:function(){return this.name},getTarget:function(){return this.target},getParam:function(t,e){return e=e||null,this.params.hasOwnProperty(t)?this.params[t]:e},getParams:function(){return this.params},stopPropagation:function(){return this._propagationStopped=!0,this},isPropagationStopped:function(){return this._propagationStopped}},t.Event}),define("EasySketch/EventManager",["./EasySketch","./Event"],function(t){return t.EventManager=function(){this.events={}},t.EventManager.prototype={_prepareEvent:function(t){return"string"==typeof t&&(t=-1!==t.indexOf(" ")?t.split(" "):[t]),t},on:function(t,e){return this.attach(t,e)},attach:function(t,e){var n,i=this._prepareEvent(t);for(var s in i)i.hasOwnProperty(s)&&(n=i[s],this.events.hasOwnProperty(n)===!1&&(this.events[n]=[]),this.events[n].push(e));return this},off:function(t,e){return this.detach(t,e)},detach:function(t,e){var n,i=this._prepareEvent(t);for(var s in i)if(i.hasOwnProperty(s)&&(n=i[s],this.events.hasOwnProperty(n)))for(var o in this.events[n])this.events[n].hasOwnProperty(o)&&this.events[n][o]===e&&(this.events[n][o]=null,delete this.events[n][o]);return this},trigger:function(e,n,i){var s=null;if(this.events.hasOwnProperty(e)){s=new t.Event(e,n,i);for(var o in this.events[e])this.events[e].hasOwnProperty(o)&&this.events[e][o].call(null,s)}return s}},t.EventManager}),define("EasySketch/Util",["./EasySketch"],function(t){return t.Util={getScalePropertyName:function(t){var e="",n=t[0].style;if("transform"in n)e="transform";else for(var i=["-moz","-webkit","-o","-ms"],s="",o=0;o<i.length;o++)if(s=i[o]+"-transform",s in n){e=s;break}return e},getScale:function(t){var e=this.getScalePropertyName(t),n={x:1,y:1};if(null!==e){var i=String(t.css(e));if("none"!=i){var s=new RegExp("([0-9.-]+)","g"),o=i.match(s);n.x=parseFloat(o[0]),n.y=parseFloat(o[3])}}return n},extend:function(t,e){for(var n in t.prototype)t.prototype.hasOwnProperty(n)&&"function"==typeof t.prototype[n]&&(e.prototype.hasOwnProperty(n)||(e.prototype[n]=t.prototype[n]));for(var i in t)t.hasOwnProperty(i)&&"function"!=typeof t.prototype[n]&&(e[i]=t[i])}},t.Util}),define("EasySketch/Sketch",["./EasySketch","./EventManager","./Util"],function(t,e,n){return t.Sketch=function(t,n){this.lastMouse={x:0,y:0},this.disabled=!1,this.binded=!1,this.drawing=!1,this.events=new e,this.eraser=!1,this.canvas=this._createCanvas(t),this.context=this.canvas.get(0).getContext("2d"),this.overlay=null,this.overlayContext=null,this.points=[],this.options={color:"#000000",width:5,alpha:1,bindingObject:null,autoBind:!0,doubleBuffering:!1},this.listeners={start:this.startDrawing.bind(this),draw:this.makeDrawing.bind(this),stop:this.stopDrawing.bind(this)},this.addons=[],n&&this.setOptions(n),this.options.doubleBuffering===!0&&this._createOverlay(),this.options.autoBind===!0&&this.attachListeners(),this._attachStandardListeners()},t.Sketch.NOTIFY_START_EVENT="notify.start",t.Sketch.NOTIFY_PAINT_EVENT="notify.paint",t.Sketch.NOTIFY_STOP_EVENT="notify.stop",t.Sketch.NOTIFY_LINE_DRAWN="notify.line.drawn",t.Sketch.prototype={selectContext:function(){return this.options.doubleBuffering===!0&&this.eraser===!1?this.overlayContext:this.context},selectCanvas:function(){return this.options.doubleBuffering===!0?this.overlay:this.canvas},setOptions:function(t){return this.options=$.extend(this.options,t||{}),this},setOption:function(t,e){return"string"==typeof t&&this.options.hasOwnProperty(t)&&(this.options[t]=e),this},getOption:function(t,e){return e=e||null,this.options.hasOwnProperty(t)?this.options[t]:e},getDrawingOptions:function(){return{color:this.options.color,width:this.options.width,alpha:this.options.alpha}},getEventManager:function(){return this.events},_createCanvas:function(t){var e,n=typeof t;switch(n){case"string":0===t.indexOf("#")?e=$(t):-1===t.indexOf(".")&&(e=$("#"+t));break;case"object":e=t instanceof jQuery?t:$(t)}return-1===e.css("position").indexOf("absolute")&&e.css("position","absolute"),isNaN(parseInt(e.css("top")))&&e.css("top",0),isNaN(parseInt(e.css("left")))&&e.css("left",0),e},_createOverlay:function(){this.canvas.parent().css("position","relative");var t=$("<canvas></canvas>");return t.addClass("drawing-overlay"),t.attr("width",this.canvas.attr("width")),t.attr("height",this.canvas.attr("height")),t.css("position","absolute"),t.css("top",this.canvas.css("top")),t.css("left",this.canvas.css("top")),this.canvas.after(t),this.options.bindingObject=t,this.overlayContext=t.get(0).getContext("2d"),this.overlay=t,this},_autoAdjustOverlay:function(){if(null!==this.overlay){var t=n.getScale(this.canvas);this.overlay.attr("width",this.canvas.attr("width")),this.overlay.attr("height",this.canvas.attr("height")),this.overlay.css("position","absolute"),this.overlay.css("top",this.canvas.css("top")),this.overlay.css("left",this.canvas.css("top")),this.overlay.css(n.getScalePropertyName(this.canvas),"scale("+t.x+", "+t.y+")")}return this},_attachStandardListeners:function(){return this.canvas.on("DOMAttrModified",this._autoAdjustOverlay.bind(this)),this},attachListeners:function(){if(this.binded===!0)return this;this.binded=!0;var t;return t=null!==this.getOption("bindingObject")?this.options.bindingObject:this.canvas,t.on("mousedown touchstart",this.listeners.start),t.on("mousemove touchmove",this.listeners.draw),t.on("mouseup mouseleave mouseout touchend touchcancel",this.listeners.stop),this},detachListeners:function(){if(this.binded===!1)return this;this.binded=!1;var t;return t=null!==this.getOption("bindingObject")?this.options.bindingObject:this.canvas,t.off("mousedown touchstart",this.listeners.start),t.off("mousemove touchmove",this.listeners.draw),t.off("mouseup mouseleave mouseout touchend touchcancel",this.listeners.stop),this},getPointerPosition:function(t){var e=this,i=n.getScale(this.selectCanvas());return t.hasOwnProperty("originalEvent")&&t.originalEvent.hasOwnProperty("changedTouches")&&t.originalEvent.changedTouches.length>0&&(t.pageX=t.originalEvent.changedTouches[0].pageX,t.pageY=t.originalEvent.changedTouches[0].pageY),{x:Math.ceil((t.pageX-e.canvas.offset().left)/i.x),y:Math.ceil((t.pageY-e.canvas.offset().top)/i.y)}},enableEraser:function(t){return this.eraser=t,this},contextSetup:function(t){return t=t||this.selectContext(),t.save(),t.strokeStyle=this.options.color,t.lineWidth=this.options.width,t.globalAlpha=this.options.alpha,t.lineCap="round",t.lineJoin="round",this},contextRestore:function(t){return t=t||this.selectContext(),t.restore(),this},startDrawing:function(e){if(this.drawing===!0||this.disabled===!0)return this;e.preventDefault();var n=this.getPointerPosition(e);return this.drawing=!0,this.lastMouse=n,this.contextSetup(),this.options.doubleBuffering===!0&&this.eraser===!1&&this.points.push(n),this.getEventManager().trigger(t.Sketch.NOTIFY_START_EVENT,this,[n]),this},makeDrawing:function(e){if(this.drawing===!1||this.disabled===!0)return this;e.preventDefault();var n=this.getPointerPosition(e);return this.drawPoints([this.lastMouse,n],this.selectContext()),this.lastMouse=n,this.options.doubleBuffering===!0&&this.eraser===!1&&(this.points.push(n),this.redrawBuffer()),this.getEventManager().trigger(t.Sketch.NOTIFY_PAINT_EVENT,this,[n]),this},stopDrawing:function(){return this.drawing===!1?this:(this.drawing=!1,this.canvas.css("cursor","auto"),this.contextRestore(),this.options.doubleBuffering===!0&&this.eraser===!1&&(this.drawLine(this.points,!0),this.points=[],this.clearOverlay()),this.getEventManager().trigger(t.Sketch.NOTIFY_STOP_EVENT,this),this)},redrawBuffer:function(){return this.clearOverlay(),this.drawPoints(this.points,this.overlayContext),this},drawPoints:function(t,e){t=t.slice();var n=t.shift();for(this.eraser&&(e.save(),e.strokeStyle="rgba(0,0,0,1)",e.globalAlpha=1,e.globalCompositeOperation="destination-out"),e.beginPath(),e.moveTo(n.x,n.y);t.length>0;)n=t.shift(),e.lineTo(n.x,n.y);return e.stroke(),e.closePath(),this.eraser&&e.restore(),this},drawLine:function(e,n){n=n||!1;var i=this.context;return this.contextSetup(i),this.drawPoints(e,i),this.contextRestore(i),n||this.getEventManager().trigger(t.Sketch.NOTIFY_LINE_DRAWN,this,[e,this.getDrawingOptions()]),this},clear:function(){return this.context.clearRect(0,0,this.canvas[0].width,this.canvas[0].height),this},clearOverlay:function(){return this.overlayContext instanceof CanvasRenderingContext2D&&this.overlayContext.clearRect(0,0,this.overlay[0].width,this.overlay[0].height),this},registerAddon:function(t){return this.addons.push(t),t.attachSketchObject(this),this}},t.Sketch}),define("EasySketch/Addon/Addon",["../EasySketch"],function(t){return t.Addon=function(){},t.Addon}),define("EasySketch/Addon/AbstractAddon",["../EasySketch","./Addon"],function(t){return t.Addon.AbstractAddon=function(){this.object=null},t.Addon.AbstractAddon.prototype={attachSketchObject:function(t){return this.object=t,this}},t.Addon.AbstractAddon}),define("EasySketch/Addon/Redo",["./AbstractAddon","../Util"],function(t,e){return t.Redo=function(t){this._dataStore=t},t.Redo.prototype={execute:function(){var t=this._dataStore.redo();if(0==t.length)return this;var e=this.object.getDrawingOptions();return this.object.setOptions(t.options),this.object.drawLine(t.points,!0),this.object.setOptions(e),this}},e.extend(t,t.Redo),t.Redo}),define("EasySketch/Addon/Undo",["../EasySketch","./AbstractAddon","../Util"],function(t,e,n){return e.Undo=function(t){this._dataStore=t},e.Undo.prototype={execute:function(){this.object.clear(),this._dataStore.undo();var t=this.object.getDrawingOptions(),e=this._dataStore.getVisibleLines();for(var n in e)e.hasOwnProperty(n)&&(this.object.setOptions(e[n].options),this.object.drawLine(e[n].points,!0));return this.object.setOptions(t),this}},n.extend(e,e.Undo),e.Undo}),define("EasySketch/Addon/UndoRedoDataStore",["../EasySketch","./AbstractAddon"],function(t,e){return e.UndoRedoDataStore=function(e){this._object=e,this._lines=[],this._stashedLines=[],this._currentLine=[];var n=this._object.getEventManager();n.attach(t.Sketch.NOTIFY_START_EVENT,this.onPaint.bind(this)).attach(t.Sketch.NOTIFY_PAINT_EVENT,this.onPaint.bind(this)).attach(t.Sketch.NOTIFY_STOP_EVENT,this.onStopPaint.bind(this)).attach(t.Sketch.NOTIFY_LINE_DRAWN,this.onLineDrawn.bind(this))},e.UndoRedoDataStore.prototype={onPaint:function(t){return this._currentLine.push(t.getParam(0)),this},onStopPaint:function(){return this._lines.push({points:this._currentLine,options:this._object.getDrawingOptions()}),this._currentLine=[],this._stashedLines=[],this},getVisibleLines:function(){return this._lines},onLineDrawn:function(t){return this._lines.push({points:t.getParam(0),options:t.getParam(1)}),this},pushLine:function(t){return this._lines.push(t),this},undo:function(){return this._lines.length<=0?this:(this._stashedLines.push(this._lines.pop()),this)},redo:function(){if(this._stashedLines.length<=0)return[];var t=this._stashedLines.pop();return this._lines.push(t),t},reset:function(){return this._lines=[],this._stashedLines=[],this}},e.UndoRedoDataStore}),requirejs(["EasySketch/Sketch","EasySketch/Addon/Redo","EasySketch/Addon/Undo","EasySketch/Addon/UndoRedoDataStore"],function(t,e,n,i){var s=new t("#drawing-canvas",{doubleBuffering:!0}),o=new i(s),r=new n(o),a=new e(o);s.registerAddon(r),s.registerAddon(a),$("#pencil").on("click",function(){s.enableEraser(!1)}),$("#eraser").on("click",function(){s.enableEraser(!0)}),$("#clear").on("click",function(){s.clear(),o.clear()}),$("#undo").on("click",function(){r.execute()}),$("#redo").on("click",function(){a.execute()}),$("#line-width-control").on("change",function(){var t=$(this).val();s.setOptions({width:t}),$(".line-width-controls").find(".info").html(t+"px")}),$("#line-color-control").on("change",function(){var t=$(this).val();s.setOptions({color:t})}),$("#line-opacity-control").on("change",function(){var t=$(this).val();s.setOptions({alpha:t}),$(".line-opacity-controls").find(".info").html(100*t+"%")}),s.setOptions({alpha:.1}),s.drawLine([{x:20,y:10},{x:40,y:100},{x:60,y:10}]),s.drawLine([{x:5,y:10},{x:15,y:50},{x:30,y:10}]),s.setOptions({alpha:1}),s.getEventManager().attach(t.NOTIFY_PAINT_EVENT,function(t){console.log("drawing at "+JSON.stringify(t.getParam(0)))})}),define("Main/app",function(){});